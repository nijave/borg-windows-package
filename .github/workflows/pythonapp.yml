name: Package borg and cygwin

on:
  push:
  schedule:
    - cron: "0 17 * * *"

jobs:
  build-borg:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@master

      - name: Install cygwin base
        run: |
          choco config get cacheLocation
          For ($i = 0; $i -le 3; $i++) {
            choco install --no-progress cygwin
            If($?) {
              break
            }
          }

      - name: Install cygwin borgbackup reqs
        run: |
          C:\tools\cygwin\cygwinsetup.exe -nqWgv `
              -s http://mirrors.kernel.org/sourceware/cygwin/ `
              -R C:\tools\cygwin `
              -P cygwin-devel,gcc-g++,libssl-devel,python36,python36-pip,python36-devel | Out-String
          Write-Output $?

      - name: Build borgbackup wheel
        id: build-whl
        run: |
          dos2unix "$(pwd)\build.sh"
          C:\tools\cygwin\bin\bash.exe --login "$(pwd)\build.sh"

      - name: Upload borgbackup wheel
        uses: actions/upload-artifact@master
        with:
          name: ${{ steps.build-whl.outputs.version }}
          path: ${{ steps.build-whl.outputs.whl }}
